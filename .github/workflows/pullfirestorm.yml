name: Auto Pull from Firestorm Repository

on:
  schedule:
    - cron: '0 5 * * *'  # jeden Morgen 5 Uhr 0 5 * * *
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout eigenes Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Hole Standard-Branch von Firestorm
        id: get_default_branch
        run: |
          DEFAULT_BRANCH=$(curl -s https://api.github.com/repos/FirestormViewer/phoenix-firestorm | jq -r .default_branch)
          echo "default_branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "üì¶ Standard-Branch ist: $DEFAULT_BRANCH"

      - name: Firestorm Remote hinzuf√ºgen und fetchen
        run: |
          git remote add firestorm https://github.com/FirestormViewer/phoenix-firestorm.git
          git fetch firestorm ${{ steps.get_default_branch.outputs.default_branch }}

      - name: Check f√ºr √Ñnderungen
        id: check_changes
        run: |
          if ! git diff --quiet HEAD firestorm/${{ steps.get_default_branch.outputs.default_branch }}; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "‚úÖ √Ñnderungen gefunden"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "‚ùå Keine √Ñnderungen gefunden"
          fi

      - name: Merge √Ñnderungen
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git merge --no-edit firestorm/${{ steps.get_default_branch.outputs.default_branch }}
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          git push origin $CURRENT_BRANCH

      - name: Starte Build Workflow bei √Ñnderungen
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Phoenix-FirestormOS.yml
          token: ${{ secrets.GITHUB_TOKEN }}
