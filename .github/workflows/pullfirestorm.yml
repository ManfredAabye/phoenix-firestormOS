name: Pull from Firestorm Repository

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  simple-pull:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Hole Firestorm Standard-Branch
        id: get_default
        run: |
          DEFAULT_BRANCH=$(curl -s https://api.github.com/repos/FirestormViewer/phoenix-firestorm | jq -r .default_branch)
          echo "default_branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT

      - name: Firestorm remote hinzufügen und fetchen
        run: |
          git remote add firestorm https://github.com/FirestormViewer/phoenix-firestorm.git
          git fetch firestorm ${{ steps.get_default.outputs.default_branch }}

      - name: Erstelle temporären Branch von Firestorm ohne Workflows
        run: |
          set -euo pipefail
          # aktuellen Branch merken
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT

          # neuen lokalen Branch aus Firestorm-Branch erstellen
          git checkout -b tmp-firestorm "firestorm/${{ steps.get_default.outputs.default_branch }}"

          # .github/workflows entfernen (falls vorhanden) damit kein Workflow-File zurückkommt
          if [ -d ".github/workflows" ]; then
            git rm -rf .github/workflows || true
            git commit -m "Remove workflows before merge" || true
          fi

          # zurück zum ursprünglichen Branch
          git checkout "$CURRENT_BRANCH"

      - name: Merge tmp-firestorm in aktuellen Branch
        run: |
          set -euo pipefail
          # Merge aus tmp-firestorm (enthält keine Workflow-Dateien)
          git merge --no-edit tmp-firestorm || { echo "Merge fehlgeschlagen - bitte manuell prüfen"; exit 1; }

      - name: Push Änderungen
        run: |
          git push origin HEAD

      - name: Cleanup temp branch (lokal)
        if: always()
        run: |
          git branch -D tmp-firestorm || true
