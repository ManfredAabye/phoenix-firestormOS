name: Firestorm OS Windows WebRTC OpenAL AVX2 Build V010

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      PYTHON_VERSION: '3.10.11'
      BUILD_DIR: D:\a\Firestorm_Build
      SCRIPT_DIR: D:\a\fs_include
      CONFIG: ReleaseFS_open
      ARCH: 64

    steps:
    - name: 🧾 Checkout Main Repo
      uses: actions/checkout@v3

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 🛠️ Setup Visual Studio Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: 📦 Install Python Dependencies
      shell: cmd
      run: |
        python -m pip install --upgrade pip
        python -m pip install --force-reinstall --no-cache-dir llbase llsd autobuild

    - name: 📁 Create Build Directory
      shell: cmd
      run: |
        mkdir "%BUILD_DIR%"
        mkdir "%BUILD_DIR%\venv"

    - name: 🔄 Clone Phoenix-Firestorm
      shell: cmd
      run: |
        git clone https://github.com/FirestormViewer/phoenix-firestorm.git "%BUILD_DIR%\phoenix-firestorm"

    - name: 🔄 Clone fs-build-variables
      shell: cmd
      run: |
        git clone https://github.com/FirestormViewer/fs-build-variables.git "%BUILD_DIR%\fs-build-variables"

    - name: 🔄 Clone fs-build-firestorm-viewer-german
      shell: cmd
      run: |
        git clone https://github.com/ManfredAabye/fs-build-firestorm-viewer-german.git "%SCRIPT_DIR%"

    - name: 🔧 Copy fs_include into Build
      shell: cmd
      run: |
        xcopy /E /I /Y "%SCRIPT_DIR%" "%BUILD_DIR%\fs_include"

    - name: 🔧 Replace autobuild.xml
      shell: cmd
      run: |
        copy /Y "%BUILD_DIR%\fs_include\autobuild.xml" "%BUILD_DIR%\phoenix-firestorm\autobuild.xml"

    - name: 🔧 Configure Build
      shell: cmd
      run: |
        cd /d "%BUILD_DIR%\phoenix-firestorm"
        autobuild installables remove webrtc
        autobuild installables add webrtc platform=windows64 url=https://github.com/secondlife/3p-webrtc-build/releases/download/m114.5735.08.73-alpha/webrtc-m114.5735.08.73-alpha.11958809572-windows64-11958809572.tar.zst hash_algorithm=sha1 hash=c7b329d6409576af6eb5b80655b007f52639c43b
        autobuild installables edit openal platform=windows64 url=https://github.com/secondlife/3p-openal-soft/releases/download/v1.24.2-r1/openal-1.24.2-r1-windows64-13245988487.tar.zst hash_algorithm=sha1 hash=8ad24fba1191c9cb0d2ab36e64b04b4648a99f43
        autobuild configure --config-file autobuild.xml -A 64 -c ReleaseFS_open -- --avx2 --openal --package --chan WebRTC -DLL_TESTS:BOOL=FALSE -DFMOD:BOOL=OFF -DUSE_OPENAL=ON

    - name: 🏗️ Build Firestorm OS
      shell: cmd
      run: |
        cd /d "%BUILD_DIR%\phoenix-firestorm"
        autobuild build --config-file autobuild.xml -A 64 -c ReleaseFS_open --no-configure --verbose

    - name: 📦 Package Viewer
      shell: cmd
      run: |
        cd /d "%BUILD_DIR%\phoenix-firestorm"
        autobuild package -A 64 --config-file autobuild.xml
